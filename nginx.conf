upstream vercel_backend {
    # Health check: checks every 3 seconds, marks down after 2 failures
    server vercel-app-1.vercel.app max_fails=2 fail_timeout=30s;
    server vercel-app-2.vercel.app max_fails=2 fail_timeout=30s;
    server vercel-app-3.vercel.app max_fails=2 fail_timeout=30s;

    # Keep connections alive
    keepalive 32;
}

# Cache zones for file chunks
proxy_cache_path /var/cache/nginx/chunks
    levels=1:2
    keys_zone=chunks_cache:50m
    max_size=1g
    inactive=10m
    use_temp_path=off;

server {
    listen 80;
    server_name files.thnkandgrow.com;

    # Increase buffer sizes for file uploads
    client_max_body_size 10m;
    client_body_buffer_size 128k;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Timeouts for file operations
    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Logging format with upstream server info
    log_format upstream_log '$remote_addr - $remote_user [$time_local] '
        '"$request" $status $body_bytes_sent '
        '"$http_referer" "$http_user_agent" '
        'upstream: $upstream_addr '
        'latency: ${request_time}s '
        'cache: $upstream_cache_status';
    
    access_log /var/log/nginx/files.thnkandgrow.com_access.log upstream_log;
    error_log /var/log/nginx/files.thnkandgrow.com_error.log warn;

    # Health check endpoint (returns 200)
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # Cache chunks endpoint - cacheable GET requests
    location ~ ^/api/chunks {
        proxy_cache chunks_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        
        # Add cache status header for debugging
        add_header X-Cache-Status $upstream_cache_status;
        
        proxy_pass https://vercel_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Upload endpoint - no caching, stream directly
    location ~ ^/api/upload {
        proxy_pass https://vercel_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Preserve Content-Range header for chunked uploads
        proxy_pass_request_headers on;
    }

    # Download endpoint - stream directly
    location ~ ^/api/download {
        proxy_pass https://vercel_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API endpoints - no caching
    location /api/ {
        proxy_pass https://vercel_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Static files - cache aggressively
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass https://vercel_backend;
        proxy_cache chunks_cache;
        proxy_cache_valid 200 30d;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

        add_header Cache-Control "public, max-age=2592000, immutable";
        add_header X-Cache-Status $upstream_cache_status;
    }

    # Root and all other requests
    location / {
        proxy_pass https://vercel_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Block suspicious requests
    location ~ /\. {
        deny all;
        access_log off;
    }
}
