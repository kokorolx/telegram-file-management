# Master Password Recovery Plan

## Current Problems

1. **Using login password to reset master password** - weak because:
   - Login password and master password represent different security domains
   - Compromised login password compromises all encryption
   - Violates principle of least privilege
   - Makes both credentials equally sensitive

2. **No actual recovery for forgotten passwords** - if user forgets master password, all files are lost
3. **No accountability** - no audit trail for who reset what and when
4. **No graceful degradation** - either full access or nothing

---

## Best Practice Approach: Account Recovery Codes

### Core Principles

1. **Separation of Concerns**: Master password reset mechanism should be independent
2. **User Control**: Recovery codes are generated by the user (not system-imposed)
3. **One-Time Use**: Each code is single-use and burns after consumption
4. **Secure Storage**: Codes hashed and stored like passwords
5. **Time-Bounded**: Can set expiration on codes
6. **No Recovery for Forgotten Master Password** (intentional):
   - User never forgets master password; they choose a new one
   - Recovery codes only work when user can authenticate with login password
   - This ensures attacker cannot reset master password with only DB access

### Why This Is Better

| Aspect | Current (Login PW) | Recovery Codes |
|--------|-------------------|-----------------|
| **Security Domain** | Mixes auth & encryption | Separate recovery path |
| **Compromise Impact** | Loses both access & encryption | Only resets encryption |
| **User Control** | None | User generates & stores codes |
| **Audit Trail** | Implicit (in auth logs) | Explicit code burn events |
| **Usability** | Confuses domains | Clear recovery mechanism |
| **Account Lockout** | Harder to prevent | Can lock after N attempts |

---

## Implementation Plan

### Phase 1: Database Schema

Add recovery code table and fields to users:

```sql
-- Add to user table
ALTER TABLE users ADD COLUMN IF NOT EXISTS recovery_codes_enabled BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS recovery_codes_generated_at TIMESTAMP;
ALTER TABLE users ADD COLUMN IF NOT EXISTS last_master_password_change TIMESTAMP;

-- New recovery codes table
CREATE TABLE recovery_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  code_hash VARCHAR(255) NOT NULL,  -- bcrypt hash of the code
  used BOOLEAN DEFAULT FALSE,
  used_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP,  -- optional: default 1 year
  burned_reason VARCHAR(50)  -- 'used', 'expired', 'revoked'
);

-- Index for cleanup queries
CREATE INDEX idx_recovery_codes_user_id_used 
  ON recovery_codes(user_id, used);
```

### Phase 2: Recovery Code Service

New `RecoveryCodeService` (lib/recoveryCodeService.js):

```javascript
export class RecoveryCodeService {
  // Generate 10 recovery codes (format: XXXX-XXXX-XXXX-XXXX)
  generateCodes(count = 10) {
    // Return plaintext + hashes
    // Hashes stored in DB
    // User saves plaintext codes
  }

  // Save codes to DB
  async saveCodes(userId, codeHashes, expiresIn = 365 * 24 * 60 * 60 * 1000) {
    // Store hashes with user_id and expiry
    // Update users.recovery_codes_enabled = true
  }

  // Verify code works for master password reset
  async verifyRecoveryCode(userId, code) {
    // Find unused, non-expired code for user
    // Compare against hash
    // Return { valid, codeRecord }
  }

  // Burn code after use
  async burnCode(codeId, reason = 'used') {
    // Mark as used, set used_at
    // Set burned_reason
  }

  // List user's codes (hashed display - last 4 chars visible)
  async listUserCodes(userId) {
    // Return format like: XXXX-****-****-1A2B (used), XXXX-****-****-3C4D
  }

  // Revoke all codes
  async revokeAllCodes(userId) {
    // Mark all unused codes as revoked
  }

  // Cleanup expired codes (run as cron job)
  async cleanupExpiredCodes() {
    // Delete codes where expires_at < now AND burned_reason = 'expired'
  }
}
```

### Phase 3: API Endpoints

#### 3a. Generate Recovery Codes
**POST /api/auth/recovery-codes/generate**

Requires:
- Valid session (authenticated)
- Login password verification (re-auth)

Response:
```json
{
  "success": true,
  "codes": [
    "ABCD-EFGH-IJKL-MNOP",
    "QRST-UVWX-YZAB-CDEF",
    "..."
  ],
  "expiresAt": "2026-12-21T00:00:00Z",
  "warning": "Save these codes in a secure location. They cannot be recovered if lost."
}
```

#### 3b. Reset Master Password with Recovery Code
**POST /api/auth/reset-master-with-recovery**

Requires:
- Valid session (authenticated)
- Recovery code (not login password)

```json
{
  "loginPassword": "string",  // still verify identity
  "recoveryCode": "ABCD-EFGH-IJKL-MNOP",
  "newMasterPassword": "string"
}
```

Response:
```json
{
  "success": true,
  "message": "Master password reset successfully",
  "codesRemaining": 9
}
```

#### 3c. List Recovery Codes
**GET /api/auth/recovery-codes**

Response:
```json
{
  "enabled": true,
  "generatedAt": "2024-12-21T10:00:00Z",
  "codesRemaining": 9,
  "codesExpireAt": "2025-12-21T00:00:00Z",
  "codes": [
    {
      "id": "uuid",
      "display": "XXXX-****-****-MNOP",
      "used": false,
      "usedAt": null,
      "createdAt": "2024-12-21T10:00:00Z"
    },
    // ... more
  ]
}
```

#### 3d. Revoke All Codes
**POST /api/auth/recovery-codes/revoke**

Requires:
- Valid session
- Login password verification

Response:
```json
{
  "success": true,
  "message": "All recovery codes revoked. Generate new codes to enable recovery again."
}
```

### Phase 4: Frontend Components

#### 4a. Recovery Code Modal
**components/RecoveryCodeModal.jsx**

Shows when user first enables recovery:
- Display 10 codes
- Copy button for each
- Download as text file button
- Print button
- "I have saved these codes" checkbox (must be checked)
- Warning banner in red

#### 4b. Recovery Code Settings
**components/RecoveryCodeSettings.jsx**

In Settings page:
- Recovery codes status (enabled/disabled)
- Last generated date
- Remaining codes count
- Button to generate new codes (disables old ones)
- Button to revoke all
- List of codes with status

#### 4c. Reset Master Password Flow
**components/ResetMasterPasswordModal.jsx** (modified)

Add conditional logic:
```javascript
if (recoveryCodesEnabled && !useLoginPassword) {
  // Show recovery code input
  // Show login password input (for identity verification)
} else if (hasRecoveryCodes) {
  // Offer choice: use recovery code or login password
}
```

### Phase 5: User Onboarding & Migration Strategy

#### 5a. New Users (After Feature Launch)

**Current Flow:**
1. User registers â†’ redirects to login
2. User logs in â†’ `SetupModal` shows for master password setup
3. User enters master password â†’ vault accessible

**New Flow (with recovery codes):**
1. User registers â†’ redirects to login
2. User logs in â†’ `SetupModal` shows for master password setup
3. User enters master password + confirms â†’ vault accessible
4. **NEW: `RecoveryCodeModal` auto-triggers after vault setup**
5. Recovery code modal shows:
   - 10 one-time recovery codes (formatted: XXXX-XXXX-XXXX-XXXX)
   - Large warning box explaining importance
   - Copy-to-clipboard buttons for each code
   - Download as .txt file button
   - Print button
   - "I have saved/written down these codes in a secure location" checkbox (must check to proceed)
   - Only then can user close and access vault

**Implementation Details:**
- Add `recovery_codes_generated_on_first_setup` flag to users table
- Modify `SetupModal.jsx` to emit callback when setup completes
- Add `RecoveryCodeModal.jsx` component that shows after setup
- On successful code generation, set flag to true
- If user closes modal without saving (refresh), reminder banner on next login

#### 5b. Existing Users (Soft Migration)

**Phase 1: Notification (Week 1-2 of rollout)**
- Add banner in Settings: "ðŸ” New: Recovery Codes for Master Password Security"
- Link to "Enable Recovery Codes" button
- Non-intrusive, user can dismiss
- Banner shows daily until enabled

**Phase 2: Recovery Code Settings Page (Week 2)**
- New dedicated section in Settings panel: "Recovery & Security"
- Status: "Not enabled yet"
- Button: "Generate Recovery Codes Now"
- One-click onboarding with same modal flow as new users

**Phase 3: Smart Reminders (Week 3-4)**
- If user logs in from new device/browser: show gentle modal reminder
- If user hasn't set recovery codes after 30 days: notification badge on settings
- After 90 days: optional gentle warning (not blocking)

**Phase 4: Soft Deprecation (After 6 months)**
- Add warning to login password reset endpoint: "Recovery codes are now recommended..."
- Timeline for deprecating login password method (announce 3 months prior)

#### 5c. Migration Script

```javascript
// scripts/enable-recovery-codes-schema.js
/**
 * Adds recovery code infrastructure to DB
 * Run once before feature launch
 */
await db.execute(`
  ALTER TABLE users ADD COLUMN IF NOT EXISTS 
    recovery_codes_enabled BOOLEAN DEFAULT FALSE;
  
  ALTER TABLE users ADD COLUMN IF NOT EXISTS 
    recovery_codes_generated_on_first_setup BOOLEAN DEFAULT FALSE;
  
  ALTER TABLE users ADD COLUMN IF NOT EXISTS 
    last_master_password_change TIMESTAMP;
  
  CREATE TABLE IF NOT EXISTS recovery_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    code_hash VARCHAR(255) NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    used_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP DEFAULT (CURRENT_TIMESTAMP + interval '1 year'),
    burned_reason VARCHAR(50),
    INDEX idx_recovery_codes_user_id_used (user_id, used)
  );
`);

console.log('âœ… Recovery codes infrastructure ready');
```

### Phase 6: Audit & Monitoring

Log recovery code events:
```javascript
// Audit table or log
{
  "event_type": "recovery_code_generated",
  "user_id": "uuid",
  "ip_address": "string",
  "user_agent": "string",
  "timestamp": "2024-12-21T10:00:00Z"
}

{
  "event_type": "recovery_code_used",
  "user_id": "uuid",
  "code_id": "uuid",
  "ip_address": "string",
  "timestamp": "2024-12-21T10:00:00Z"
}

{
  "event_type": "recovery_codes_revoked",
  "user_id": "uuid",
  "reason": "user_request|expiry|login_password_reset",
  "timestamp": "2024-12-21T10:00:00Z"
}
```

---

## Security Considerations

### Threats Mitigated

| Threat | Current | New Method |
|--------|---------|------------|
| Brute force login | Bcrypt helps | Bcrypt helps |
| Brute force master password | None | Recovery codes hashed |
| DB compromise | Attacker can reset master password with login hash | Attacker cannot reset master password; codes are hashed |
| Phishing (login PW) | Compromises everything | Only compromises account access, not encryption |
| User forgets master password | Files lost | Still lost (intentional; recovery codes don't help here) |
| Attacker steals recovery codes | Uses them to reset encryption | User can revoke, limited attempts per user |

### Attack Scenarios

**Scenario 1: User device compromised**
- Attacker has access to browser session
- Cannot use recovery codes (requires login)
- Cannot get new login session (already has one)
- User notices unusual activity â†’ revoke codes â†’ generate new ones

**Scenario 2: Database compromised**
- Attacker has code hashes but not plaintext codes
- Cannot brute force easily (hashed like passwords, bcrypt)
- Cannot reset master password without login password
- Can slow down with rate limiting

**Scenario 3: User forgets master password**
- Recovery codes cannot help (by design)
- Files remain encrypted and inaccessible
- User can:
  - Check if they have written-down codes (for access to encrypted files from other devices)
  - Generate new master password for NEW files
  - Accept that old files are lost

---

## New User Journey (Detailed Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User Registration (existing)                                  â”‚
â”‚    - Fill username & password                                    â”‚
â”‚    - Click "Sign Up"                                             â”‚
â”‚    - Redirected to login page                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. User Login (existing)                                         â”‚
â”‚    - Enter credentials                                           â”‚
â”‚    - Click "Login"                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SetupModal - Master Password (existing, no change)           â”‚
â”‚    - User creates master password                                â”‚
â”‚    - Confirms password                                           â”‚
â”‚    - Clicks "Secure Vault"                                       â”‚
â”‚    - Vault is unlocked, files accessible                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. SetupModal onSetupComplete callback triggers                 â”‚
â”‚    - Sets flag: recovery_codes_generated_on_first_setup = false  â”‚
â”‚    - Condition check: if !recovery_codes_generated_on_first_setup
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. RecoveryCodeModal auto-shows (NEW)                           â”‚
â”‚                                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â”‚ ðŸ” PROTECT YOUR VAULT                        â”‚             â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚    â”‚ Your recovery codes are your backup plan.    â”‚             â”‚
â”‚    â”‚ Store them safely offline.                   â”‚             â”‚
â”‚    â”‚                                              â”‚             â”‚
â”‚    â”‚ âš ï¸ WARNING:                                  â”‚             â”‚
â”‚    â”‚ These codes are ONE-TIME USE only.          â”‚             â”‚
â”‚    â”‚ After using one to reset your master password
â”‚    â”‚ it will be burned and unusable.             â”‚             â”‚
â”‚    â”‚                                              â”‚             â”‚
â”‚    â”‚ Lost codes cannot be recovered.             â”‚             â”‚
â”‚    â”‚ Generate new ones from settings anytime.    â”‚             â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚    â”‚ Your 10 Recovery Codes:                      â”‚             â”‚
â”‚    â”‚                                              â”‚             â”‚
â”‚    â”‚ â˜ AABB-CCDD-EEFF-GGHH [copy] [print]       â”‚             â”‚
â”‚    â”‚ â˜ IIJJ-KKLL-MMNN-OOFF [copy]               â”‚             â”‚
â”‚    â”‚ â˜ ... (8 more codes)                        â”‚             â”‚
â”‚    â”‚                                              â”‚             â”‚
â”‚    â”‚ [Download as Text] [Print All]              â”‚             â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚    â”‚ â˜‘ï¸ I have saved these codes in a secure     â”‚             â”‚
â”‚    â”‚    location (written down, file, etc)       â”‚             â”‚
â”‚    â”‚                                              â”‚             â”‚
â”‚    â”‚ [âœ“ Got it - Access My Vault]                â”‚             â”‚
â”‚    â”‚ [Skip for Now]                              â”‚             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                   â”‚
â”‚    Actions:                                                      â”‚
â”‚    - Copy each code (copy icon next to each)                    â”‚
â”‚    - Download as .txt file                                      â”‚
â”‚    - Print all codes                                            â”‚
â”‚    - Checkbox must be checked to proceed                        â”‚
â”‚    - Only "Got it" button works if checkbox checked             â”‚
â”‚    - "Skip for Now" saves flag as false + shows banner later    â”‚
â”‚                                                                  â”‚
â”‚    Backend:                                                      â”‚
â”‚    - Generate 10 codes via RecoveryCodeService                  â”‚
â”‚    - Hash them (bcrypt)                                         â”‚
â”‚    - Store in recovery_codes table                              â”‚
â”‚    - Set recovery_codes_enabled = true on users                 â”‚
â”‚    - Set recovery_codes_generated_on_first_setup = true         â”‚
â”‚    - Log event: "recovery_codes_generated"                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. User in Vault (after confirming codes saved)                 â”‚
â”‚    - Can now upload/download files normally                     â”‚
â”‚    - Recovery codes are safe in user's secure location          â”‚
â”‚    - If user needs to reset master password later:              â”‚
â”‚      â†’ Settings â†’ "Recovery & Security"                         â”‚
â”‚      â†’ "Reset Master Password"                                  â”‚
â”‚      â†’ Can use recovery code instead of login password          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FALLBACK: If user skips the modal (closes/refresh)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Recovery Code Warning Banner (shown until codes generated)      â”‚
â”‚                                                                   â”‚
â”‚ âš ï¸ No recovery codes yet! Generate them now to protect your      â”‚
â”‚    vault from permanent data loss.                              â”‚
â”‚ [Generate Now] [Dismiss]                                         â”‚
â”‚                                                                   â”‚
â”‚ Appears on:                                                      â”‚
â”‚ - Dashboard (top banner) - every login until enabled            â”‚
â”‚ - Settings panel - persistent badge                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Order

1. **Week 1**: Database schema + RecoveryCodeService
2. **Week 2**: API endpoints (all 4)
3. **Week 3**: 
   - RecoveryCodeModal component
   - SetupModal integration (callback)
   - Warning banner for existing users
4. **Week 4**: Settings page "Recovery & Security" section
5. **Week 5**: Testing, edge cases, docs
6. **Week 6**: Soft launch with feature flag
7. **Week 7**: Remove feature flag, monitor, soft deprecate login password method

---

## Alternative Approaches (Considered & Rejected)

### 1. Email-based Password Reset
**Why not**: User email can be compromised; creates recovery method for forgotten passwords that shouldn't exist.

### 2. Security Questions
**Why not**: Answers are often findable (social engineering, public records); weak entropy.

### 3. SMS OTP
**Why not**: Ties to phone number; phone can be SIM-swapped; requires external dependency.

### 4. Passkeys/WebAuthn
**Why not**: Good for login, but doesn't solve master password reset for same device.

### 5. Backup Encryption Keys
**Why not**: Same problem as recovery codes but more confusing.

---

## Key Requirements: Ensuring Users Get Recovery Codes

### For NEW Users (After Feature Launch)

**Requirement: Must show recovery code modal before user can fully access vault**

1. **Trigger Point**: Immediately after SetupModal completes
2. **Modal Behavior**:
   - Appears automatically (no dismiss button that skips entirely)
   - User MUST either:
     - Check "I have saved codes" + Click "Got it" â†’ access vault + codes generated
     - Click "Skip for Now" â†’ codes NOT generated + warning banner shows on next login
3. **Recovery Code Persistence**:
   - Store `recovery_codes_generated_on_first_setup = true` in DB
   - Never auto-show modal again if this flag is true
   - Warning banner shows if flag is false

### For EXISTING Users (Before Feature Launch)

**Requirement: Gentle onboarding, no forced generation**

1. **Show Banner**: "New feature: Recovery Codes" in settings (dismissible)
2. **Optional Button**: "Generate Now" in Settings â†’ Recovery & Security section
3. **Smart Reminder**: Banner reappears after 7 days if still not generated
4. **No Blocking**: User can use app normally without generating codes
5. **Clear Value**: Messaging emphasizes this is for THEIR protection only

### Database Tracking

```sql
-- On users table:
recovery_codes_enabled BOOLEAN DEFAULT FALSE
  â†“ Set TRUE when codes successfully generated

recovery_codes_generated_on_first_setup BOOLEAN DEFAULT FALSE
  â†“ Set TRUE when new user generates codes after setup
  â†“ Prevents re-showing modal on next login

-- On recovery_codes table:
used BOOLEAN DEFAULT FALSE
  â†“ Prevents code reuse
  
expires_at TIMESTAMP
  â†“ Prevents indefinite usage (1 year default)

created_at TIMESTAMP
  â†“ For audit trail
```

### Testing Checklist for Modal Display

- [ ] New user registers â†’ after setup â†’ recovery modal shows
- [ ] Recovery modal has all 10 codes displayed
- [ ] Copy buttons work for each code
- [ ] Download as .txt works
- [ ] Print functionality works
- [ ] Checkbox is unchecked initially
- [ ] "Got it" button disabled until checkbox checked
- [ ] "Skip for Now" button always available
- [ ] After clicking "Got it":
  - [ ] Modal closes
  - [ ] User can access vault normally
  - [ ] `recovery_codes_generated_on_first_setup` is TRUE in DB
  - [ ] `recovery_codes_enabled` is TRUE in DB
  - [ ] Codes are hashed and stored in recovery_codes table
- [ ] After clicking "Skip for Now":
  - [ ] Modal closes
  - [ ] User can access vault normally
  - [ ] `recovery_codes_generated_on_first_setup` stays FALSE
  - [ ] Warning banner appears on next login
  - [ ] Banner has "Generate Now" button
  - [ ] Clicking "Generate Now" shows recovery modal again

---

## Recommendations

1. **Implement recovery codes** - best balance of security & usability
2. **Keep login password method for 6 months** - smooth migration
3. **Add rate limiting** - 5 attempts per hour per user
4. **Add account lock** - 10 failed attempts in 24h â†’ lock 1 hour
5. **Email notifications** - alert user when codes generated/used
6. **Monitoring dashboard** - track recovery code usage patterns
7. **User education** - docs on why recovery codes, how to store them
8. **Force new user onboarding** - auto-show modal after setup completion
9. **Audit all events** - track code generation, usage, revocation

